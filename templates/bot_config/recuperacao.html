{% extends "base.html" %}

{% block title %}Recupera√ß√£o de Carrinho - Bot Manager{% endblock %}

{% block content %}
<h1>Configurar Recupera√ß√£o de Carrinho</h1>

<!-- Lista de planos com recupera√ß√£o -->
{% if planos_com_recuperacao %}
<div class="form-container">
    <h2>Planos com Recupera√ß√£o Ativa</h2>
    <table>
        <thead>
            <tr>
                <th>Plano</th>
                <th>Valor Recupera√ß√£o</th>
                <th>Tempo (min)</th>
                <th>A√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            {% for plano in planos_com_recuperacao %}
            <tr>
                <td>{{ plano.name }}</td>
                <td>R$ {{ plano.recovery.value }}</td>
                <td>{{ plano.recovery.tempo }} min</td>
                <td>
                    <button class="btn btn-danger" onclick="removeRecuperacao('{{ loop.index0 }}')">Remover</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Adicionar recupera√ß√£o -->
{% if planos_sem_recuperacao %}
<div class="form-container" style="margin-top: 20px;">
    <h2>Adicionar Recupera√ß√£o a um Plano</h2>
    <form method="POST" enctype="multipart/form-data" id="recuperacaoForm">
        <div class="form-group">
            <label>Selecione o Plano</label>
            <select name="plano_index" required>
                <option value="">Escolha um plano...</option>
                {% for plano in planos_sem_recuperacao %}
                <option value="{{ loop.index0 }}">{{ plano.name }} - R$ {{ plano.value }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Mensagem de Recupera√ß√£o</label>
            <textarea name="texto" rows="4" required placeholder="Ex: üî• √öLTIMA CHANCE! Voc√™ ainda pode garantir seu acesso com um SUPER DESCONTO!"></textarea>
        </div>
        
        <div class="form-group">
            <label>M√≠dia (Opcional)</label>
            <input type="file" name="midia" accept="image/*,video/*">
        </div>
        
        <div class="form-group">
            <label>Valor da Recupera√ß√£o (R$)</label>
            <input type="number" name="valor" step="0.01" min="4" required placeholder="Ex: 19.90">
        </div>
        
        <div class="form-group">
            <label>Tempo para Disparar (minutos)</label>
            <input type="number" name="tempo" min="1" required placeholder="Ex: 30">
            <small style="display: block; margin-top: 5px; color: #666;">
                Ap√≥s quantos minutos enviar a mensagem de recupera√ß√£o
            </small>
        </div>
        
        <button type="submit" class="btn btn-success">Adicionar Recupera√ß√£o</button>
    </form>
</div>
{% else %}
<div class="alert alert-success">
    Todos os planos j√° possuem recupera√ß√£o configurada!
</div>
{% endif %}

<script>
function removeRecuperacao(planoIndex) {
    if(confirm('Tem certeza que deseja remover esta recupera√ß√£o?')) {
        fetch(window.location.pathname + '/remove/' + planoIndex, {
            method: 'POST'
        })
        .then(() => window.location.reload());
    }
}
</script>
{% endblock %}